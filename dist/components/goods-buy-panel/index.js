"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _class,_temp2,_createClass=function(){function a(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,n){return t&&a(e.prototype,t),n&&a(e,n),e}}(),_get=function e(t,n,a){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,n);if(void 0===i){var s=Object.getPrototypeOf(t);return null===s?void 0:e(s,n,a)}if("value"in i)return i.value;var r=i.get;return void 0!==r?r.call(a):void 0},_index=require("../../npm/@tarojs/taro-weapp/index.js"),_index2=_interopRequireDefault(_index),_index3=require("../../utils/index.js"),_index4=require("../../api/index.js"),_index5=_interopRequireDefault(_index4);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var o=e.apply(this,arguments);return new Promise(function(s,r){return function t(e,n){try{var a=o[e](n),i=a.value}catch(e){return void r(e)}if(!a.done)return Promise.resolve(i).then(function(e){t("next",e)},function(e){t("throw",e)});s(i)}("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var GoodsBuyPanel=(_temp2=_class=function(e){function r(){var e,t,g,a,m=this;_classCallCheck(this,r);for(var n=arguments.length,i=Array(n),s=0;s<n;s++)i[s]=arguments[s];return(t=g=_possibleConstructorReturn(this,(e=r.__proto__||Object.getPrototypeOf(r)).call.apply(e,[this].concat(i)))).$usedState=["anonymousState__temp","anonymousState__temp4","anonymousState__temp5","anonymousState__temp6","anonymousState__temp7","info","loopArray0","curImg","curSkus","noSpecs","maxStore","quantity","type","hasStore","busy","isDrug","fastBuyText","marketing","selection","curSku","isActive","__fn_onChange","__fn_onAddCart","__fn_onFastbuy","isOpened"],g.getSkuProps=function(){if(!g.props.info)return"";var e=g.state.curSku;return g.noSpecs?"":e?"已选 “"+e.propsText+"”":"请选择"},g.handleQuantityChange=function(e){g.setState({quantity:e})},g.handleSelectSku=function(e,t){if(!g.disabledSet.has(e.spec_value_id)){var n=g.state.selection;n[t]===e.spec_value_id?n[t]=null:n[t]=e.spec_value_id,g.updateCurSku(n),g.setState({selection:n})}},g.toggleShow=function(e){void 0===e&&(e=!g.state.isActive),g.setState({isActive:e}),g.props.onClose&&g.__triggerPropsFn("onClose",[null].concat([]))},g.handleBuyClick=(a=_asyncToGenerator(regeneratorRuntime.mark(function e(t,n,a){var i,s,r,o,u,l,c,_,p,d,f,y;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(g.state.busy)return e.abrupt("return");e.next=2;break;case 2:if(i=g.state,s=i.marketing,r=i.info,o=r.special_type,u="drug"===o,l=g.noSpecs?r:n,c=l.item_id,_="/pages/cart/espier-checkout",g.setState({busy:!0}),"cart"===t)return _="/pages/cart/espier-index",e.prev=10,e.next=13,_index5.default.cart.add({item_id:c,num:a,shop_type:u?"drug":"distributor"});e.next=21;break;case 13:e.next=18;break;case 15:e.prev=15,e.t0=e.catch(10),console.log(e.t0);case 18:_index2.default.showToast({title:"成功加入购物车",icon:"success"}),g.setState({busy:!1}),g.__triggerPropsFn("onAddCart",[null].concat([c,a]));case 21:if("fastbuy"!==t){e.next=46;break}if(_+="?cart_type=fastbuy","group"!==s){e.next=28;break}p=r.group_activity.groups_activity_id,_+="&type="+s+"&group_id="+p,e.next=35;break;case 28:if("seckill"===s)return d=r.seckill_activity.seckill_id,e.next=32,_index5.default.item.seckillCheck({item_id:c,seckill_id:d,num:a});e.next=35;break;case 32:f=e.sent,y=f.ticket,_+="&type="+s+"&seckill_id="+d+"&ticket="+y;case 35:return e.prev=35,e.next=38,_index5.default.cart.fastBuy({item_id:c,num:a});case 38:e.next=43;break;case 40:e.prev=40,e.t1=e.catch(35),console.log(e.t1);case 43:g.setState({busy:!1}),g.__triggerPropsFn("onFastbuy",[null].concat([c,a])),_index2.default.navigateTo({url:_});case 46:case"end":return e.stop()}},e,m,[[10,15],[35,40]])})),function(e,t,n){return a.apply(this,arguments)}),g.$$refs=[],_possibleConstructorReturn(g,t)}return _inherits(r,_index.Component),_createClass(r,[{key:"_constructor",value:function(e){_get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"_constructor",this).call(this,e),this.state={marketing:"normal",selection:[],curSku:null,curImg:null,quantity:1,isActive:e.isOpened},this.disabledSet=new Set}},{key:"componentDidMount",value:function(){console.log(this.state);var e=this.props.info,t=e.spec_items,n=e.group_activity?"group":e.seckill_activity?"seckill":"normal",a={};t.forEach(function(e){var t=e.item_spec.map(function(e){return e.spec_value_id}).join("_"),n=e.item_spec.map(function(e){return e.spec_value_name}).join(" ");e.propsText=n,a[t]=e});var i=Array(e.item_spec_desc.length).fill(null);this.skuDict=a,this.setState({marketing:n,selection:i}),t&&t.length||(this.noSpecs=!0)}},{key:"componentWillReceiveProps",value:function(e){var t=e.isOpened;t!==this.state.isActive&&this.setState({isActive:t})}},{key:"calcDisabled",value:function(e){for(var i=this.skuDict,t=new Set,n=function(e,t,n){var a=function(e,n,a){var t=e.slice().map(function(e,t){return n===t?a:e||"(\\d+)"}).join("_");return new RegExp(t)}(e,t,n);return Object.keys(i).some(function(e){return e.match(a)&&0<i[e].store})},a=this.props.info,s=0,r=a.item_spec_desc.length;s<r;s++)for(var o=a.item_spec_desc[s].spec_values,u=0,l=o.length;u<l;u++){var c=o[u].spec_value_id;t.has(c)||n(e,s,c)||t.add(c)}this.disabledSet=t}},{key:"getCurSkuImg",value:function(e){var t=this.props.info.pics[0];return e&&e.item_spec.some(function(e){if(e.spec_image_url)return t=e.spec_image_url,!0}),t}},{key:"updateCurSku",value:function(e){if(e=e||this.state.selection,this.calcDisabled(e),e.some(function(e){return!e}))return this.setState({curSku:null,curImg:null}),void this.__triggerPropsFn("onChange",[null].concat([null]));var t=this.skuDict[e.join("_")],n=this.getCurSkuImg(t);this.setState({curSku:t,curImg:n}),this.__triggerPropsFn("onChange",[null].concat([t])),_index3.log.debug("[goods-buy-panel] updateCurSku: ",t)}},{key:"_createData",value:function(){var n=this;this.__state=arguments[0]||this.state||{},this.__props=arguments[1]||this.props||{};arguments[2];var e=this.noSpecs,t=this.__props,a=t.info,i=t.type,s=t.fastBuyText,r=this.__state,o=(r.curImg,r.quantity,r.selection),u=r.isActive,l=r.busy,c=r.curSku;if(!a)return null;var _="drug"===a.special_type,p=this.noSpecs?a:c,d=+(p?p.store:a.store||99999),f=p?0<p.store:0<a.store,y=(0,_index3.classNames)("goods-buy-panel",u?"goods-buy-panel__active":null);this.anonymousFunc0=function(){return n.toggleShow(!1)};var g="cart"===i&&f?(0,_index3.classNames)("goods-buy-panel__btn btn-add-cart",{"is-disabled":!p}):null,m="cart"===i&&f?Boolean(!p):null,v="fastbuy"===i&&f?(0,_index3.classNames)("goods-buy-panel__btn btn-fast-buy",{"is-disabled":!p}):null,h="fastbuy"===i&&f?Boolean(!p):null,b=a.item_spec_desc.map(function(e,t){return{$anonymousCallee__0:(e={$original:(0,_index.internal_get_original)(e)}).$original.spec_values.map(function(e){return e={$original:(0,_index.internal_get_original)(e)},{$loopState__temp3:(0,_index3.classNames)("sku-item",{"is-active":e.$original.spec_value_id===o[t],"is-disabled":n.disabledSet.has(e.$original.spec_value_id)}),$original:e.$original}}),$original:e.$original}});return Object.assign(this.__state,{anonymousState__temp:y,anonymousState__temp4:g,anonymousState__temp5:m,anonymousState__temp6:v,anonymousState__temp7:h,info:a,loopArray0:b,curSkus:p,noSpecs:e,maxStore:d,type:i,hasStore:f,busy:l,isDrug:_,fastBuyText:s}),this.__state}},{key:"anonymousFunc0",value:function(e){}}]),r}(),_class.properties={info:{type:null,value:null},__fn_onChange:{type:null,value:null},onClose:{type:null,value:null},__fn_onClose:{type:null,value:null},__fn_onAddCart:{type:null,value:null},__fn_onFastbuy:{type:null,value:null},type:{type:null,value:null},fastBuyText:{type:null,value:null},isOpened:{type:null,value:null}},_class.$$events=["anonymousFunc0","handleSelectSku","handleQuantityChange","handleBuyClick"],_class.options={addGlobalClass:!0},_class.defaultProps={info:null,isOpened:!1,type:"fastbuy",fastBuyText:"立即购买",busy:!1,onClose:function(){},onChange:function(){},onClickAddCart:function(){},onClickFastBuy:function(){}},_temp2);exports.default=GoodsBuyPanel,Component(require("../../npm/@tarojs/taro-weapp/index.js").default.createComponent(GoodsBuyPanel));