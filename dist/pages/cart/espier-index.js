"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _dec,_dec2,_class,_class2,_temp2,_initialiseProps,_extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t},_createClass=function(){function r(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(t,e,n){return e&&r(t.prototype,e),n&&r(t,n),t}}(),_get=function t(e,n,r){null===e&&(e=Function.prototype);var a=Object.getOwnPropertyDescriptor(e,n);if(void 0===a){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in a)return a.value;var o=a.get;return void 0!==o?o.call(r):void 0},_index=require("../../npm/@tarojs/taro-weapp/index.js"),_index2=_interopRequireDefault(_index),_index3=require("../../npm/@tarojs/redux/index.js"),_index4=require("../../utils/index.js"),_debounce=require("../../npm/lodash/debounce.js"),_debounce2=_interopRequireDefault(_debounce),_index5=require("../../api/index.js"),_index6=_interopRequireDefault(_index5),_index7=require("../../hocs/index.js"),_cart=require("../../store/cart.js");function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _asyncToGenerator(t){return function(){var c=t.apply(this,arguments);return new Promise(function(i,o){return function e(t,n){try{var r=c[t](n),a=r.value}catch(t){return void o(t)}if(!r.done)return Promise.resolve(a).then(function(t){e("next",t)},function(t){e("throw",t)});i(a)}("next")})}}function _toConsumableArray(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var CartIndex=(_dec=(0,_index3.connect)(function(t){var e=t.cart;return{list:e.list,cartIds:e.cartIds,defaultAllSelect:!1,totalPrice:(0,_cart.getTotalPrice)(e)}},function(n){return{onUpdateCartNum:function(t,e){return n({type:"cart/updateNum",payload:{cart_id:t,num:e}})},onUpdateCart:function(t){return n({type:"cart/update",payload:t})},onCartSelection:function(t){return n({type:"cart/selection",payload:t})}}}))(_class=(_dec2=(0,_index7.withLogin)())((_temp2=_class2=function(t){function o(){var t,e,n;_classCallCheck(this,o);for(var r=arguments.length,a=Array(r),i=0;i<r;i++)a[i]=arguments[i];return e=n=_possibleConstructorReturn(this,(t=o.__proto__||Object.getPrototypeOf(o)).call.apply(t,[this].concat(a))),_initialiseProps.call(n),_possibleConstructorReturn(n,e)}var n,r,e;return _inherits(o,_index.Component),_createClass(o,[{key:"_constructor",value:function(t){_get(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"_constructor",this).call(this,t),this.state={loading:!0,selection:new Set,cartMode:"default",curPromotions:null,groups:[],invalidList:[]},this.updating=!1,this.lastCartId=null}},{key:"componentDidMount",value:function(){var r=this;this.fetch(function(t){r.props.defaultAllSelect&&r.handleAllSelect(!0);var e=r.resolveActivityGroup(t),n=[];t.forEach(function(t){var e=t.list.filter(function(t){return t.is_checked}).map(function(t){return t.cart_id});n=[].concat(_toConsumableArray(n),_toConsumableArray(e))}),r.updateSelection(n),setTimeout(function(){r.setState({groups:e,loading:!1})},40)})}},{key:"componentWillReceiveProps",value:function(t){if(t.list!==this.props.list){var e=this.resolveActivityGroup(t.list);this.setState({groups:e})}}},{key:"resolveActivityGroup",value:function(t){return t.map(function(t){var n=t.list.reduce(function(t,e){return t[e.cart_id]=e,t},{}),e=t.activity_grouping.map(function(t){var e=t.cart_ids.map(function(t){var e=n[t];return delete n[t],e});return{activity:t,list:e}});return e.push({activity:null,list:Object.values(n)}),e})}},{key:"fetch",value:(e=_asyncToGenerator(regeneratorRuntime.mark(function t(e){var n,r,a,i,o,c=this;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,_index6.default.cart.get();case 2:n=t.sent,r=n.valid_cart,a=n.invalid_cart,i=r.map(function(t){var e=c.transformCartList(t.list);return _extends({},t,{list:e})}),o=a.map(function(t){var e=c.transformCartList(t.list);return _extends({},t,{list:e})}),this.setState({invalidList:o}),_index4.log.debug("[cart fetch]",i),this.__triggerPropsFn("onUpdateCart",[null].concat([i])),e&&e(i);case 11:case"end":return t.stop()}},t,this)})),function(t){return e.apply(this,arguments)})},{key:"updateSelection",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[];this.setState({selection:new Set(t)}),this.__triggerPropsFn("onCartSelection",[null].concat([t]))}},{key:"handleSelectionChange",value:(r=_asyncToGenerator(regeneratorRuntime.mark(function t(e,n){var r;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return(r=this.state.selection)[n?"add":"delete"](e),this.updateSelection([].concat(_toConsumableArray(r))),t.next=5,_index6.default.cart.select({cart_id:e,is_checked:n});case 5:_index4.log.debug("[cart change] item: "+e+", selection:",r),this.updateCart();case 7:case"end":return t.stop()}},t,this)})),function(t,e){return r.apply(this,arguments)})},{key:"changeCartNum",value:(n=_asyncToGenerator(regeneratorRuntime.mark(function t(e,n){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return this.updateCart.cancel(),t.next=3,_index6.default.cart.updateNum({cart_id:e,num:n});case 3:this.updateCart();case 4:case"end":return t.stop()}},t,this)})),function(t,e){return n.apply(this,arguments)})},{key:"transformCartList",value:function(t){return(0,_index4.pickBy)(t,{item_id:"item_id",cart_id:"cart_id",activity_id:"activity_id",title:"item_name",desc:"brief",is_checked:"is_checked",curSymbol:"cur.symbol",promotions:function(t){var e=t.promotions,n=void 0===e?[]:e,r=t.cart_id;return n.map(function(t){return t.cart_id=r,t})},img:function(t){return t.pics},price:function(t){return(+t.price/100).toFixed(2)},market_price:function(t){return(+t.market_price/100).toFixed(2)},num:"num"})}},{key:"_createData",value:function(){this.__state=arguments[0]||this.state||{},this.__props=arguments[1]||this.props||{};arguments[2];var t=this.__state,r=t.selection,e=t.groups,n=t.cartMode,a=t.loading,i=t.curPromotions,o=this.__props,c=o.totalPrice,u=o.list;if(a)return null;var s=r.size,l=!u.length,d=0<u[0].discount_fee&&"edit"!==n?-1*u[0].discount_fee:null,p="edit"!==n?s<=0:null,_=Boolean(i),f=e.map(function(t,e){return{$anonymousCallee__1:(t={$original:(0,_index.internal_get_original)(t)}).$original.map(function(n){return{activity:(n={$original:(0,_index.internal_get_original)(n)}).$original.activity,$anonymousCallee__0:n.$original.list.map(function(t){t={$original:(0,_index.internal_get_original)(t)};var e=r.has(t.$original.cart_id);return{activity:n.activity,$loopState__temp2:e,$original:t.$original}}),$original:n.$original}}),$original:t.$original}});return Object.assign(this.__state,{anonymousState__temp3:d,anonymousState__temp4:p,anonymousState__temp5:_,loopArray0:f,list:u,isEmpty:l,totalPrice:c,isTotalChecked:this.isTotalChecked}),this.__state}},{key:"isTotalChecked",get:function(){return this.props.cartIds.length===this.state.selection.size}}]),o}(),_class2.properties={defaultAllSelect:{type:null,value:null},list:{type:null,value:null},__fn_onUpdateCart:{type:null,value:null},cartIds:{type:null,value:null},__fn_onCartSelection:{type:null,value:null},__fn_onUpdateCartNum:{type:null,value:null},totalPrice:{type:null,value:null}},_class2.$$events=["handleQuantityChange","handleClickPromotion","handleSelectionChange","handleDelect","navigateTo","handleAllSelect","handleCheckout","handleClosePromotions","handleSelectPromotion"],_class2.defaultProps={totalPrice:"0.00",list:null},_initialiseProps=function(){var e,n,r,a,i=this;this.$usedState=["anonymousState__temp3","anonymousState__temp4","anonymousState__temp5","loopArray0","loading","groups","list","isEmpty","cartMode","totalPrice","curPromotions","selection","invalidList","defaultAllSelect","__fn_onUpdateCart","cartIds","__fn_onCartSelection","__fn_onUpdateCartNum","isTotalChecked"],this.updateCart=(0,_debounce2.default)(_asyncToGenerator(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return i.updating=!0,t.prev=1,t.next=4,i.fetch();case 4:t.next=9;break;case 6:t.prev=6,t.t0=t.catch(1),console.log(t.t0);case 9:i.updating=!1;case 10:case"end":return t.stop()}},t,i,[[1,6]])})),600),this.toggleCartMode=function(){var t="edit"!==i.state.cartMode?"edit":"default";i.setState({cartMode:t})},this.handleDelect=(e=_asyncToGenerator(regeneratorRuntime.mark(function t(e){var n;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,_index2.default.showModal({title:"将当前商品移出购物车?",showCancel:!0,cancel:"取消",confirmText:"确认",confirmColor:"#0b4137"});case 2:if(t.sent.confirm){t.next=5;break}return t.abrupt("return");case 5:return t.next=7,_index6.default.cart.del({cart_id:e});case 7:n=i.props.cartIds.filter(function(t){return t!==e}),i.updateSelection(n),i.updateCart();case 10:case"end":return t.stop()}},t,i)})),function(t){return e.apply(this,arguments)}),this.debounceChangeCartNum=(0,_debounce2.default)((n=_asyncToGenerator(regeneratorRuntime.mark(function t(e,n){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,i.changeCartNum(e,n);case 2:case"end":return t.stop()}},t,i)})),function(t,e){return n.apply(this,arguments)}),400),this.handleQuantityChange=(r=_asyncToGenerator(regeneratorRuntime.mark(function t(e,n){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(i.updating=!0,i.__triggerPropsFn("onUpdateCartNum",[null].concat([e,n])),i.updateCart.cancel(),i.lastCartId===e||void 0===i.lastCartId)return t.next=6,i.debounceChangeCartNum(e,n);t.next=8;break;case 6:t.next=11;break;case 8:return i.lastCartId=e,t.next=11,i.changeCartNum(e,n);case 11:case"end":return t.stop()}},t,i)})),function(t,e){return r.apply(this,arguments)}),this.handleAllSelect=function(t){var e=i.state.selection,n=i.props.cartIds;t?n.forEach(function(t){return e.add(t)}):e.clear(),i.updateSelection([].concat(_toConsumableArray(e)))},this.handleClickPromotion=function(e){var n=void 0;i.props.list.some(function(t){t.list.some(function(t){t.cart_id===e&&(n=t.promotions.slice())})}),i.setState({curPromotions:n})},this.handleSelectPromotion=(a=_asyncToGenerator(regeneratorRuntime.mark(function t(e){var n,r;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.marketing_id,r=e.cart_id,_index2.default.showLoading({mask:!0}),i.setState({curPromotions:null}),t.next=5,_index6.default.cart.updatePromotion({activity_id:n,cart_id:r});case 5:return t.next=7,i.fetch();case 7:_index2.default.hideLoading();case 8:case"end":return t.stop()}},t,i)})),function(t){return a.apply(this,arguments)}),this.handleClosePromotions=function(){i.setState({curPromotions:null})},this.handleCheckout=function(){i.updating?_index2.default.showToast({title:"正在计算价格，请稍后",icon:"none"}):_index2.default.navigateTo({url:"/pages/cart/espier-checkout?cart_type=cart"})},this.navigateTo=function(){for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];_index4.navigateTo.apply(i,e)},this.$$refs=[]},_class=_temp2))||_class)||_class;exports.default=CartIndex,Component(require("../../npm/@tarojs/taro-weapp/index.js").default.createComponent(CartIndex,!0));